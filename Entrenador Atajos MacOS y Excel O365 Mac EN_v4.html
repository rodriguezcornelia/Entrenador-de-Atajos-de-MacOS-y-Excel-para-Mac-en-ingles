<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entrenador de Atajos ¬∑ macOS + Excel (Mac)</title>
  <!-- Tailwind CSS desde CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="App l√∫dica y accesible para aprender atajos de macOS y de Excel para Mac (Microsoft 365). Repetici√≥n espaciada (Leitner), anal√≠tica y similitud con sin√≥nimos ES/EN.">
  <style>
    html, body { height: 100%; }
    .keycap{
      display:inline-flex;align-items:center;justify-content:center;
      padding:.25rem .5rem;border-radius:.5rem;border:1px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.85);box-shadow:0 .5px 0 rgba(0,0,0,.12);
      min-width:2.25rem;font-weight:600
    }
    .combo{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center}
    dialog::backdrop{background:rgba(0,0,0,.45)}
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-slate-100 to-slate-200 text-slate-900">
  <main class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="mb-6 md:mb-8">
      <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight">
        Entrenador de <span class="text-blue-700">Atajos</span> ¬∑ <span class="text-emerald-700">macOS</span> + <span class="text-amber-700">Excel (Mac)</span>
      </h1>

      <!-- Etapas del prompt (plan, fuentes, etc.) -->
      <details class="mt-4 p-4 rounded-2xl bg-white/80 border shadow-sm">
        <summary class="cursor-pointer font-semibold">Plan (etapa 1), fuentes y c√≥mo ejecutar</summary>
        <div class="grid md:grid-cols-2 gap-4 mt-3">
          <div>
            <h3 class="font-bold">Plan</h3>
            <ol class="list-decimal list-inside text-slate-700">
              <li>Externalizar atajos a JSON con <code>combo, desc, keywords, app, version, fuente</code> y cargarlos din√°micamente.</li>
              <li>Juego con temporizador 10s y puntos 1000‚Üí0; feedback 5s y 10 preguntas por ronda.</li>
              <li>Repetici√≥n espaciada (Leitner) y anal√≠tica de errores con <code>localStorage</code>.</li>
              <li>Verificaci√≥n con sin√≥nimos ES/EN y similitud (Levenshtein con umbral).</li>
              <li>UI accesible (45‚Äì65), Tailwind CDN, selector ES/EN, editor de dataset (importar/guardar/exportar).</li>
            </ol>
          </div>
          <div>
            <h3 class="font-bold">Fuentes sugeridas</h3>
            <ul class="list-disc list-inside text-slate-700">
              <li>Apple Support ‚Äì atajos de <strong>macOS</strong>.</li>
              <li>Microsoft Support ‚Äì atajos de Excel para Mac (Microsoft 365).</li>
            </ul>
            <h3 class="font-bold mt-3">C√≥mo ejecutar</h3>
            <ol class="list-decimal list-inside text-slate-700">
              <li>Guarda este archivo como <code>atajos-mac-excel.html</code>.</li>
              <li>√Åbrelo con doble clic en tu navegador. No requiere instalaci√≥n.</li>
              <li>(Opcional) Usa ‚ÄúDataset‚Äù para importar/editar tu JSON y ‚ÄúAnal√≠tica‚Äù para reforzar errores.</li>
            </ol>
          </div>
        </div>
      </details>
    </header>

    <!-- Panel superior: controles + marcador -->
    <section class="mb-6 grid gap-4 md:grid-cols-3">
      <!-- Controles -->
      <div class="p-4 md:p-6 rounded-3xl bg-white shadow-sm border">
        <h2 class="text-xl font-bold mb-3" data-i18n="practice_mode">Modo de pr√°ctica</h2>
        <div class="flex flex-wrap gap-3">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" id="chkMac" class="h-5 w-5" checked>
            <span class="text-xs font-semibold rounded-full px-2 py-1 bg-emerald-700 text-white">macOS</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" id="chkExcel" class="h-5 w-5" checked>
            <span class="text-xs font-semibold rounded-full px-2 py-1 bg-amber-600 text-white">Excel (Mac)</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" id="chkMezclar" class="h-5 w-5" checked>
            <span class="text-xs font-semibold rounded-full px-2 py-1 bg-blue-700 text-white" data-i18n="shuffle">Mezclar</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" id="chkSensibilidad" class="h-5 w-5" checked>
            <span class="text-xs font-semibold rounded-full px-2 py-1 bg-gray-700 text-white" data-i18n="allow_synonyms">Permitir sin√≥nimos</span>
          </label>
        </div>

        <div class="mt-4 grid gap-3">
          <div class="flex items-center justify-between gap-3">
            <label class="text-sm text-slate-600" for="rngUmbral" data-i18n="strictness">Umbral de similitud (0.60‚Äì0.95)</label>
            <input id="rngUmbral" type="range" min="0.60" max="0.95" step="0.01" value="0.78" class="w-40" />
            <span id="lblUmbral" class="text-sm font-semibold">0.78</span>
          </div>
          <div class="flex flex-wrap gap-3">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="modo" value="leitner" class="h-5 w-5" checked>
              <span class="text-xs font-semibold rounded-full px-2 py-1 bg-purple-700 text-white" data-i18n="mode_leitner">Repaso (Leitner)</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="modo" value="aleatorio" class="h-5 w-5">
              <span class="text-xs font-semibold rounded-full px-2 py-1 bg-slate-700 text-white" data-i18n="mode_random">Pr√°ctica aleatoria</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" id="chkRefuerzo" class="h-5 w-5">
              <span class="text-xs font-semibold rounded-full px-2 py-1 bg-rose-700 text-white" data-i18n="reinforce">Refuerzo (errores)</span>
            </label>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <button id="btnReiniciar" class="px-4 py-3 rounded-2xl font-semibold shadow-sm border bg-white hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-300" data-i18n="reset_score">
            Reiniciar marcador
          </button>
          <button id="btnLista" class="px-4 py-3 rounded-2xl font-semibold shadow-sm border bg-white hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-300" data-i18n="view_list">
            Ver lista de atajos
          </button>
          <button id="btnDataset" class="px-4 py-3 rounded-2xl font-semibold shadow-sm border bg-white hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-300 col-span-2" data-i18n="dataset_manager">
            Dataset (importar / editar / exportar)
          </button>
          <button id="btnAnalytics" class="px-4 py-3 rounded-2xl font-semibold shadow-sm border bg-white hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-300 col-span-2" data-i18n="analytics">
            Anal√≠tica de errores
          </button>
        </div>

        <div class="mt-4 flex items-center gap-3">
          <label for="selLang" class="text-sm text-slate-600" data-i18n="language">Idioma UI</label>
          <select id="selLang" class="border rounded-xl p-2">
            <option value="es">ES</option>
            <option value="en">EN</option>
          </select>
        </div>

        <p class="mt-3 text-sm text-slate-500" id="tipPista">Tip: si te atascas, usa ‚ÄúPista‚Äù. ¬°Cada intento te acerca a la maestr√≠a! üöÄ</p>
      </div>

      <!-- Marcador -->
      <div class="p-4 md:p-6 rounded-3xl bg-white shadow-sm border col-span-2">
        <h2 class="text-xl font-bold mb-3" data-i18n="score_progress">Marcador & Progreso</h2>
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 text-center">
          <div>
            <div class="text-slate-500 text-base" data-i18n="hits">Aciertos</div>
            <div id="ok" class="text-2xl md:text-3xl font-extrabold text-emerald-700">0</div>
          </div>
          <div>
            <div class="text-slate-500 text-base" data-i18n="misses">Fallos</div>
            <div id="ko" class="text-2xl md:text-3xl font-extrabold text-rose-700">0</div>
          </div>
          <div>
            <div class="text-slate-500 text-base" data-i18n="streak">Racha</div>
            <div id="streak" class="text-2xl md:text-3xl font-extrabold text-blue-700">0</div>
          </div>
          <div>
            <div class="text-slate-500 text-base" data-i18n="round">Ronda</div>
            <div id="ronda" class="text-xl md:text-2xl font-bold">1/10</div>
          </div>
          <div>
            <div class="text-slate-500 text-base" data-i18n="total">Total</div>
            <div id="puntosTotales" class="text-2xl md:text-3xl font-extrabold text-emerald-700">0</div>
          </div>
          <div>
            <div class="text-slate-500 text-base" data-i18n="pool">Pool</div>
            <div id="progreso" class="text-xl md:text-2xl font-bold">0/0</div>
          </div>
        </div>

        <div class="mt-5 grid gap-3 md:grid-cols-3">
          <div class="rounded-2xl border p-3">
            <div class="text-slate-500 text-sm" data-i18n="time_per_question">‚è±Ô∏è Tiempo (pregunta)</div>
            <div id="tiempo" class="text-2xl font-extrabold" aria-live="polite">10.0s</div>
            <div class="mt-2 h-3 rounded-full bg-slate-100 overflow-hidden" aria-hidden="true">
              <div id="barraTiempo" class="h-3 bg-blue-600" style="width:100%"></div>
            </div>
          </div>
          <div class="rounded-2xl border p-3">
            <div class="text-slate-500 text-sm" data-i18n="points_per_question">üèÜ Puntos (pregunta)</div>
            <div id="puntosPregunta" class="text-2xl font-extrabold">1000</div>
          </div>
          <div class="rounded-2xl border p-3">
            <div class="text-slate-500 text-sm" data-i18n="leitner_box">üì¶ Caja Leitner</div>
            <div id="lblCaja" class="text-2xl font-extrabold">‚Äì</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tarjeta principal -->
    <section class="rounded-3xl bg-white shadow-lg border ring-1 ring-black/5">
      <div class="p-5 md:p-10">
        <div class="flex items-center justify-between gap-3 mb-6">
          <span id="categoria" class="text-xs font-semibold rounded-full px-2 py-1 bg-slate-800 text-white">‚Äì</span>
          <div class="flex items-center gap-2">
            <button id="btnPista" class="px-4 py-2 rounded-2xl font-semibold shadow-sm border bg-white hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-300 text-sm" data-i18n="hint">
              Pista
            </button>
            <button id="btnNoSe" class="px-4 py-2 rounded-2xl font-semibold shadow-sm border bg-white hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-300 text-sm" data-i18n="idk">
              No la s√©
            </button>
          </div>
        </div>

        <div class="text-center">
          <div class="combo text-3xl md:text-5xl font-extrabold mb-6" id="combo" aria-label="Combinaci√≥n de teclas">
            <!-- teclas aqu√≠ -->
          </div>
          <p class="text-slate-700 mb-4 text-lg" id="enunciado">
            ¬øPara qu√© sirve este atajo? ¬°Responde r√°pido y suma a lo grande!
          </p>

          <div class="grid gap-3 md:grid-cols-[1fr_auto]">
            <input id="respuesta" type="text" inputmode="text" aria-label="Tu respuesta"
                   class="w-full text-xl md:text-2xl px-4 py-3 rounded-2xl border focus:outline-none focus:ring-4 focus:ring-blue-300"
                   placeholder="Escribe tu respuesta (p. ej., Copiar / Rellenar abajo)‚Ä¶" autocomplete="off" />
            <button id="btnComprobar" class="px-4 py-3 rounded-2xl font-semibold shadow-sm bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 text-lg" data-i18n="check">
              Comprobar
            </button>
          </div>

          <div id="feedback" class="mt-5 text-lg md:text-xl font-semibold min-h-[2.25rem]" aria-live="polite" role="status"></div>

          <div class="mt-6 flex flex-wrap gap-3 justify-center">
            <button id="btnSiguiente" class="px-4 py-3 rounded-2xl font-semibold shadow-sm bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300" disabled data-i18n="next">
              Siguiente atajo
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Modal lista -->
    <dialog id="dlgLista" class="rounded-2xl w-[min(100%,60rem)]">
      <div class="bg-white rounded-2xl p-6 max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-2xl font-bold" data-i18n="shortcuts_list">Lista de atajos incluidos</h3>
          <button class="px-4 py-2 rounded-2xl font-semibold shadow-sm border bg-white hover:bg-gray-50" onclick="dlgLista.close()" data-i18n="close">Cerrar</button>
        </div>
        <div id="tablaAtajos" class="grid gap-2"></div>
      </div>
    </dialog>

    <!-- Modal dataset -->
    <dialog id="dlgDataset" class="rounded-2xl w-[min(100%,70rem)]">
      <div class="bg-white rounded-2xl p-6 max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-2xl font-bold" data-i18n="dataset_title">Dataset de atajos (JSON)</h3>
          <button class="px-4 py-2 rounded-2xl font-semibold shadow-sm border bg-white hover:bg-gray-50" onclick="dlgDataset.close()" data-i18n="close">Cerrar</button>
        </div>
        <p class="text-slate-600 mb-3" data-i18n="dataset_help">Edita, importa o exporta tu JSON. Los campos requeridos son: combo, desc, keywords[], app, version, fuente.</p>
        <div class="flex flex-wrap gap-3 mb-3">
          <input type="file" id="fileImport" accept=".json" class="border rounded-xl p-2" />
          <button id="btnImport" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 font-semibold" data-i18n="import">Importar</button>
          <button id="btnExport" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 font-semibold" data-i18n="export">Exportar</button>
          <button id="btnResetDataset" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 font-semibold" data-i18n="restore_defaults">Restaurar por defecto</button>
          <button id="btnSaveDataset" class="px-3 py-2 rounded-xl border bg-blue-600 text-white hover:bg-blue-700 font-semibold" data-i18n="save">Guardar</button>
        </div>
        <textarea id="txtDataset" class="w-full h-[50vh] border rounded-xl p-3 font-mono text-sm"></textarea>
      </div>
    </dialog>

    <!-- Modal analytics -->
    <dialog id="dlgAnalytics" class="rounded-2xl w-[min(100%,60rem)]">
      <div class="bg-white rounded-2xl p-6 max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-2xl font-bold" data-i18n="analytics_title">Anal√≠tica de errores</h3>
          <button class="px-4 py-2 rounded-2xl font-semibold shadow-sm border bg-white hover:bg-gray-50" onclick="dlgAnalytics.close()" data-i18n="close">Cerrar</button>
        </div>
        <p class="text-slate-600 mb-4" data-i18n="analytics_help">M√°s alto = m√°s dif√≠cil. Usa el modo ‚ÄúRefuerzo (errores)‚Äù para priorizarlos.</p>
        <div id="tblAnalytics" class="grid gap-2"></div>
      </div>
    </dialog>

    <!-- Modal resultados -->
    <dialog id="dlgResultados" class="rounded-2xl w-[min(100%,36rem)]">
      <div class="bg-white rounded-2xl p-6">
        <h3 class="text-2xl font-extrabold mb-2" data-i18n="well_done">¬°Bien jugado! üèÅ</h3>
        <p class="text-slate-600 mb-4" data-i18n="ten_questions">Has completado 10 preguntas. ¬°Sigue practicando y tu memoria muscular te lo agradecer√°!</p>
        <div class="grid grid-cols-2 gap-3 text-center mb-5">
          <div class="rounded-2xl border p-4">
            <div class="text-slate-500 text-sm" data-i18n="hits">Aciertos</div>
            <div id="resAciertos" class="text-2xl font-extrabold text-emerald-700">0</div>
          </div>
          <div class="rounded-2xl border p-4">
            <div class="text-slate-500 text-sm" data-i18n="misses">Fallos</div>
            <div id="resFallos" class="text-2xl font-extrabold text-rose-700">0</div>
          </div>
          <div class="rounded-2xl border p-4 col-span-2">
            <div class="text-slate-500 text-sm" data-i18n="total_points">Puntuaci√≥n total</div>
            <div id="resPuntos" class="text-3xl font-extrabold text-blue-700">0</div>
          </div>
        </div>
        <div class="flex flex-wrap gap-3 justify-end">
          <button class="px-4 py-3 rounded-2xl font-semibold shadow-sm border bg-white hover:bg-gray-50" onclick="dlgResultados.close()" data-i18n="close">Cerrar</button>
          <button id="btnVolverJugar" class="px-4 py-3 rounded-2xl font-semibold shadow-sm bg-blue-600 text-white hover:bg-blue-700" data-i18n="play_again">
            Jugar otra vez
          </button>
        </div>
      </div>
    </dialog>

    <footer class="mt-10 text-sm text-slate-600">
      <p>Dise√±o para adultos (45‚Äì65): tipograf√≠as grandes, contrastes altos y controles claros. ¬°Tu cerebro tambi√©n se entrena! üß†‚ú®</p>
    </footer>
  </main>

  <!-- ===== Dataset por defecto como JSON (editable/actualizable) ===== -->
<script id="atajos-default" type="application/json">
[
  {"combo":"‚åò + C","desc":"Copiar","keywords":["copiar","copy"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + X","desc":"Cortar","keywords":["cortar","cut"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + V","desc":"Pegar","keywords":["pegar","paste"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + Z","desc":"Deshacer","keywords":["deshacer","undo"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚áß ‚åò + Z","desc":"Rehacer","keywords":["rehacer","redo"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + A","desc":"Seleccionar todo","keywords":["seleccionar todo","select all"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + S","desc":"Guardar","keywords":["guardar","save"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚áß ‚åò + S","desc":"Guardar como‚Ä¶","keywords":["guardar como","save as"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + P","desc":"Imprimir","keywords":["imprimir","print"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + O","desc":"Abrir","keywords":["abrir","open"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + W","desc":"Cerrar ventana/pesta√±a","keywords":["cerrar ventana","close window","close tab"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚å• ‚åò + W","desc":"Cerrar todas las ventanas","keywords":["cerrar todas","close all"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + N","desc":"Nueva ventana/documento","keywords":["nueva ventana","new window","new document"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + T","desc":"Nueva pesta√±a","keywords":["nueva pesta√±a","new tab"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + Q","desc":"Salir de la app actual","keywords":["salir","quit app"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + H","desc":"Ocultar app actual","keywords":["ocultar","hide"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚å• ‚åò + H","desc":"Ocultar otras apps","keywords":["ocultar otras","hide others"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + M","desc":"Minimizar ventana","keywords":["minimizar","minimize"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚å• ‚åò + M","desc":"Minimizar todas las ventanas","keywords":["minimizar todas","minimize all"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},

  {"combo":"‚åò + F","desc":"Buscar","keywords":["buscar","find"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + G","desc":"Buscar siguiente","keywords":["siguiente coincidencia","find next"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚áß ‚åò + G","desc":"Buscar anterior","keywords":["coincidencia anterior","find previous"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + Barra espaciadora","desc":"Abrir Spotlight","keywords":["spotlight","buscar apps","buscar archivos","search"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åÉ ‚åò + Barra espaciadora","desc":"Selector de emojis/s√≠mbolos","keywords":["emoji","emojis","s√≠mbolos"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},

  {"combo":"‚åò + Tab","desc":"Cambiar de aplicaci√≥n","keywords":["cambiar app","switch apps","app siguiente"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + `","desc":"Siguiente ventana (misma app)","keywords":["ventana siguiente","next window"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚áß ‚åò + `","desc":"Ventana anterior (misma app)","keywords":["ventana anterior","previous window"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},

  {"combo":"‚áß ‚åò + 3","desc":"Captura de pantalla completa","keywords":["captura","screenshot completa","pantalla completa"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚áß ‚åò + 4","desc":"Capturar selecci√≥n","keywords":["captura seleccion","screenshot area"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚áß ‚åò + 4, luego Barra espaciadora","desc":"Capturar ventana","keywords":["capturar ventana","window screenshot"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚áß ‚åò + 5","desc":"Controles de captura/grabaci√≥n","keywords":["captura avanzada","grabaci√≥n"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},

  {"combo":"‚åÉ ‚åò + Q","desc":"Bloquear pantalla","keywords":["bloquear pantalla","lock screen"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚å• ‚åò + Esc","desc":"Forzar salida de una app","keywords":["forzar salida","force quit"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},

  {"combo":"‚åò + I (Finder)","desc":"Obtener informaci√≥n","keywords":["informaci√≥n archivo","get info"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + D (Finder)","desc":"Duplicar √≠tem","keywords":["duplicar","duplicate"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + Supr (Finder)","desc":"Mover a la Papelera","keywords":["papelera","trash"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚áß ‚åò + Supr (Finder)","desc":"Vaciar Papelera","keywords":["vaciar papelera","empty trash"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},

  {"combo":"‚å• + ‚Üê/‚Üí","desc":"Mover una palabra","keywords":["salto palabra","word left","word right"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + ‚Üê/‚Üí","desc":"Inicio/fin de l√≠nea","keywords":["inicio l√≠nea","fin l√≠nea","line start","line end"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åò + ‚Üë/‚Üì","desc":"Inicio/fin del documento","keywords":["inicio documento","fin documento","top","bottom"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚å• + Supr","desc":"Eliminar palabra anterior","keywords":["borrar palabra","delete previous word"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åÉ + ‚Üë","desc":"Mission Control","keywords":["mission control"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åÉ + ‚Üì","desc":"Ventanas de la app","keywords":["expose app windows","app windows"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},
  {"combo":"‚åÉ + ‚Üê/‚Üí","desc":"Cambiar de escritorio","keywords":["desktop siguiente","space siguiente"],"app":"macOS","version":"macOS 14+","fuente":"Apple Support"},

  {"combo":"‚åÉ + U","desc":"Editar celda (modo edici√≥n)","keywords":["editar celda","modo edicion","edit cell","in-cell edit"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"Enter","desc":"Confirmar y bajar","keywords":["confirmar","introducir","enter"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚áß + Enter","desc":"Confirmar y subir","keywords":["confirmar arriba"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"Tab","desc":"Confirmar y derecha","keywords":["ir derecha","move right"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},

  {"combo":"‚åò + Z","desc":"Deshacer","keywords":["deshacer","undo"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + Y","desc":"Rehacer/Repetir","keywords":["rehacer","repetir","redo","repeat"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + C","desc":"Copiar","keywords":["copiar","copy"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + X","desc":"Cortar","keywords":["cortar","cut"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + V","desc":"Pegar","keywords":["pegar","paste"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},

  {"combo":"‚åò + A","desc":"Seleccionar todo","keywords":["seleccionar todo","select all"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + ‚Üë/‚Üì/‚Üê/‚Üí","desc":"Ir al borde de la regi√≥n de datos","keywords":["ir al borde","edge"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åÉ + Espacio","desc":"Seleccionar columna","keywords":["seleccionar columna","select column"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚áß + Espacio","desc":"Seleccionar fila","keywords":["seleccionar fila","select row"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},

  {"combo":"‚åò + D","desc":"Rellenar hacia abajo","keywords":["rellenar abajo","fill down","copiar abajo"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + R","desc":"Rellenar hacia la derecha","keywords":["rellenar derecha","fill right","copiar derecha"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + ;","desc":"Insertar hora actual","keywords":["hora actual","current time"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åÉ + ;","desc":"Insertar fecha actual","keywords":["fecha actual","current date"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + K","desc":"Insertar hiperv√≠nculo","keywords":["hipervinculo","enlace","hyperlink"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},

  {"combo":"‚åò + B","desc":"Negrita","keywords":["negrita","bold"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + I","desc":"Cursiva","keywords":["cursiva","italic"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + U","desc":"Subrayado","keywords":["subrayado","underline"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò ‚áß + >","desc":"Aumentar tama√±o de fuente","keywords":["aumentar fuente","increase font"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò ‚áß + <","desc":"Reducir tama√±o de fuente","keywords":["reducir fuente","decrease font"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + 1","desc":"Formato de celdas","keywords":["formato celdas","format cells"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò ‚áß + %","desc":"Formato porcentaje","keywords":["formato porcentaje","percentage format"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},

  {"combo":"=","desc":"Empezar una f√≥rmula","keywords":["empezar formula","start formula"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åÉ + `","desc":"Mostrar/ocultar f√≥rmulas","keywords":["mostrar formulas","toggle formulas","show formulas"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + =","desc":"Autosuma","keywords":["autosuma","autosum","sum"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},

  {"combo":"‚åò + S","desc":"Guardar libro","keywords":["guardar","save"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + O","desc":"Abrir libro","keywords":["abrir libro","open workbook"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + W","desc":"Cerrar libro","keywords":["cerrar libro","close workbook"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + N","desc":"Nuevo libro","keywords":["nuevo libro","new workbook"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},

  {"combo":"‚åò + T","desc":"Crear tabla de Excel","keywords":["tabla","table","create table"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åÉ + L","desc":"Aplicar/quitar filtro","keywords":["filtro","filter","toggle filter"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},

  {"combo":"Fn + F11","desc":"Gr√°fico en hoja nueva","keywords":["grafico nueva hoja","chart new sheet"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},

  {"combo":"‚åò + F","desc":"Buscar","keywords":["buscar","find"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åò + H","desc":"Reemplazar","keywords":["reemplazar","replace"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},

  {"combo":"‚åò + E","desc":"Centrar (alineaci√≥n)","keywords":["centrar","center align"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"},
  {"combo":"‚åÉ + ‚Üê/‚Üí","desc":"Mover cursor una palabra (en edici√≥n)","keywords":["mover palabra","word left","word right"],"app":"Excel (Mac)","version":"Microsoft 365 Mac","fuente":"Microsoft Support"}
]
</script>



  <script>
    /* =================== utilidades b√°sicas =================== */
    const $ = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const rand = arr => arr[Math.floor(Math.random() * arr.length)];
    const keyEl = txt => `<span class="keycap">${txt}</span>`;
    const renderCombo = c => c.split("+").map(x => keyEl(x.trim())).join('<span class="text-slate-400 px-1">+</span>');

    // normalizar texto (acentos, may√∫sculas, s√≠mbolos comunes)
    const strip = s => (s ?? "")
      .toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu, "")
      .replace(/[^a-z0-9 %/.,+<>-]/g, " ")
      .replace(/\s+/g, " ")
      .trim();

    /* =================== i18n simple (UI ES/EN) =================== */
    const I18N = {
      es: {
        practice_mode: "Modo de pr√°ctica",
        shuffle: "Mezclar",
        allow_synonyms: "Permitir sin√≥nimos",
        strictness: "Umbral de similitud (0.60‚Äì0.95)",
        mode_leitner: "Repaso (Leitner)",
        mode_random: "Pr√°ctica aleatoria",
        reinforce: "Refuerzo (errores)",
        reset_score: "Reiniciar marcador",
        view_list: "Ver lista de atajos",
        dataset_manager: "Dataset (importar / editar / exportar)",
        analytics: "Anal√≠tica de errores",
        language: "Idioma UI",
        score_progress: "Marcador & Progreso",
        hits: "Aciertos", misses: "Fallos", streak: "Racha",
        round: "Ronda", total: "Total", pool: "Pool",
        time_per_question: "‚è±Ô∏è Tiempo (pregunta)",
        points_per_question: "üèÜ Puntos (pregunta)",
        leitner_box: "üì¶ Caja Leitner",
        hint: "Pista", idk: "No la s√©", check: "Comprobar", next: "Siguiente atajo",
        shortcuts_list: "Lista de atajos incluidos",
        close: "Cerrar",
        dataset_title: "Dataset de atajos (JSON)",
        dataset_help: "Edita, importa o exporta tu JSON. Los campos requeridos son: combo, desc, keywords[], app, version, fuente.",
        import: "Importar", export: "Exportar", restore_defaults: "Restaurar por defecto", save: "Guardar",
        analytics_title: "Anal√≠tica de errores",
        analytics_help: "M√°s alto = m√°s dif√≠cil. Usa el modo ‚ÄúRefuerzo (errores)‚Äù para priorizarlos.",
        well_done: "¬°Bien jugado! üèÅ",
        ten_questions: "Has completado 10 preguntas. ¬°Sigue practicando y tu memoria muscular te lo agradecer√°!",
        total_points: "Puntuaci√≥n total",
        ask_what_for: "¬øPara qu√© sirve este atajo? ¬°Responde r√°pido y suma a lo grande!",
        tip_hint: "Tip: si te atascas, usa ‚ÄúPista‚Äù. ¬°Cada intento te acerca a la maestr√≠a! üöÄ",
        correct: (pts,desc) => `üéØ ¬°Buen reflejo! Sumaste <strong>+${pts}</strong> puntos. Respuesta correcta: <strong>${desc}</strong>.`,
        wrong_time: desc => `‚è≥ Se acab√≥ el tiempo. La respuesta correcta era: <strong>${desc}</strong>.`,
        wrong_generic: desc => `‚úò No exactamente. La respuesta correcta era: <strong>${desc}</strong>.`,
        new_chance: "¬°Nueva oportunidad! Responde r√°pido y suma a lo grande üöÄ",
        play_again: "Jugar otra vez"
      },
      en: {
        practice_mode: "Practice mode",
        shuffle: "Shuffle",
        allow_synonyms: "Allow synonyms",
        strictness: "Similarity threshold (0.60‚Äì0.95)",
        mode_leitner: "Review (Leitner)",
        mode_random: "Random practice",
        reinforce: "Reinforce (errors)",
        reset_score: "Reset score",
        view_list: "View shortcuts list",
        dataset_manager: "Dataset (import / edit / export)",
        analytics: "Error analytics",
        language: "UI language",
        score_progress: "Score & Progress",
        hits: "Hits", misses: "Misses", streak: "Streak",
        round: "Round", total: "Total", pool: "Pool",
        time_per_question: "‚è±Ô∏è Time (question)",
        points_per_question: "üèÜ Points (question)",
        leitner_box: "üì¶ Leitner box",
        hint: "Hint", idk: "I don't know", check: "Check", next: "Next shortcut",
        shortcuts_list: "Included shortcuts",
        close: "Close",
        dataset_title: "Shortcuts dataset (JSON)",
        dataset_help: "Edit, import or export your JSON. Required fields: combo, desc, keywords[], app, version, fuente.",
        import: "Import", export: "Export", restore_defaults: "Restore defaults", save: "Save",
        analytics_title: "Error analytics",
        analytics_help: "Higher = harder. Use ‚ÄúReinforce (errors)‚Äù to prioritise them.",
        well_done: "Well done! üèÅ",
        ten_questions: "You completed 10 questions. Keep practicing‚Äîmuscle memory will thank you!",
        total_points: "Total score",
        ask_what_for: "What does this shortcut do? Answer fast for more points!",
        tip_hint: "Tip: stuck? Tap ‚ÄúHint‚Äù. Every attempt moves you forward! üöÄ",
        correct: (pts,desc) => `üéØ Nice! You scored <strong>+${pts}</strong>. Correct answer: <strong>${desc}</strong>.`,
        wrong_time: desc => `‚è≥ Time's up. The correct answer was: <strong>${desc}</strong>.`,
        wrong_generic: desc => `‚úò Not quite. The correct answer was: <strong>${desc}</strong>.`,
        new_chance: "New chance! Answer fast for big points üöÄ",
        play_again: "Play again"
      }
    };
    let LANG = "es";
    function applyI18N(){
      $$("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        const v = I18N[LANG][k];
        if(typeof v === "string") el.textContent = v;
      });
      $("#enunciado").textContent = I18N[LANG].ask_what_for;
      $("#tipPista").textContent = I18N[LANG].tip_hint;
    }

    /* =================== dataset + Leitner (localStorage) =================== */
    const LS_DATASET  = "atajosDatasetV1";
    const LS_LEITNER  = "atajosLeitnerV1";
    const LS_SETTINGS = "atajosSettingsV1";

    let DATASET = [];   // objetos {id, combo, desc, keywords[], app, version, fuente}
    let LEITNER = {};   // { [id]: { box, due, ok, ko, lastSeen } }

    function idFor(item){
      return btoa(unescape(encodeURIComponent(item.app+"|"+item.combo))).replace(/=+$/,"");
    }

    function loadDataset(){
      try{
        const saved = localStorage.getItem(LS_DATASET);
        const raw = saved ? saved : $("#atajos-default").textContent;
        const arr = JSON.parse(raw);
        DATASET = arr.map(o=>{
          const item = {
            combo:o.combo, desc:o.desc, keywords:o.keywords||[],
            app:o.app, version:o.version||"", fuente:o.fuente||""
          };
          item.id = idFor(item);
          return item;
        });
      }catch(e){
        alert("Error cargando dataset. Se usar√°n los valores por defecto.");
        DATASET = JSON.parse($("#atajos-default").textContent).map(o=>({ ...o, id:idFor(o) }));
      }
    }

    function saveDatasetText(txt){
      localStorage.setItem(LS_DATASET, txt);
      loadDataset(); loadLeitner(); construirPool();
    }

    function loadLeitner(){
      try{ LEITNER = JSON.parse(localStorage.getItem(LS_LEITNER) || "{}"); }catch{ LEITNER = {}; }
      const now = Date.now();
      for(const it of DATASET){
        if(!LEITNER[it.id]) LEITNER[it.id] = {box:1, due:now, ok:0, ko:0, lastSeen:0};
      }
      localStorage.setItem(LS_LEITNER, JSON.stringify(LEITNER));
    }

    function updateLeitner(id, ok){
      const now = Date.now();
      const rec = LEITNER[id] || {box:1, due:now, ok:0, ko:0, lastSeen:0};
      if(ok){ rec.ok++; rec.box = Math.min(5, rec.box+1); }
      else   { rec.ko++; rec.box = Math.max(1, rec.box-1); }
      const intervals = {1:0, 2:1, 3:3, 4:7, 5:14}; // d√≠as
      rec.due = now + intervals[rec.box]*24*60*60*1000;
      rec.lastSeen = now;
      LEITNER[id] = rec;
      localStorage.setItem(LS_LEITNER, JSON.stringify(LEITNER));
    }
    function errorScore(id){
      const r = LEITNER[id] || {ok:0, ko:0};
      return r.ko / Math.max(1, r.ok + r.ko); // 0..1
    }

    /* =================== juego: estado y selecci√≥n =================== */
    const chkMac   = $("#chkMac");
    const chkExcel = $("#chkExcel");
    const chkMezclar = $("#chkMezclar");
    const chkSens  = $("#chkSensibilidad");
    const chkRefuerzo = $("#chkRefuerzo");
    const rngUmbral = $("#rngUmbral");
    const lblUmbral = $("#lblUmbral");
    const dlgLista = $("#dlgLista");
    const dlgDataset = $("#dlgDataset");
    const dlgAnalytics = $("#dlgAnalytics");
    const dlgResultados = $("#dlgResultados");

    let pool = []; let usados = new Set(); let actual = null;

    let aciertos=0, fallos=0, racha=0, totalPuntos=0;
    let preguntasContestadas=0; const LIMITE_PREGUNTAS=10;

    let timer=null; const DURACION=10_000; const MAX_PREGUNTA=1000;
    let inicioPregunta=0; let puntosVivos=MAX_PREGUNTA; let bloqueado=false;

    function construirPool(){
      pool = DATASET.filter(x =>
        (chkMac.checked && x.app==="macOS") ||
        (chkExcel.checked && x.app==="Excel (Mac)")
      );
      if(!chkMezclar.checked){
        pool.sort((a,b)=>(a.app+b.combo).localeCompare(b.app+b.combo));
      }else{
        for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
      }
      usados.clear();
      actualizarProgreso();
    }

    function actualizarMarcador(){
      $("#ok").textContent=aciertos; $("#ko").textContent=fallos; $("#streak").textContent=racha;
      $("#puntosTotales").textContent=totalPuntos;
      $("#ronda").textContent=`${Math.min(preguntasContestadas+1, LIMITE_PREGUNTAS)}/${LIMITE_PREGUNTAS}`;
    }
    function actualizarProgreso(){ $("#progreso").textContent=`${usados.size}/${pool.length}`; }
    function setFeedback(msg, cls="text-blue-700"){ const box=$("#feedback"); box.className="mt-5 text-lg md:text-xl font-semibold min-h-[2.25rem] "+cls; box.innerHTML=msg; }
    function renderTiempo(restanteMs){
      const s=Math.max(0,restanteMs/1000); $("#tiempo").textContent=s.toFixed(1)+"s";
      const pct=Math.max(0, Math.min(1, restanteMs/DURACION)); $("#barraTiempo").style.width=(pct*100).toFixed(1)+"%";
    }
    function renderPuntosPregunta(p){ $("#puntosPregunta").textContent=Math.max(0, Math.floor(p)); }

    function iniciarTemporizador(){
      detenerTemporizador(); inicioPregunta=performance.now(); puntosVivos=MAX_PREGUNTA;
      renderPuntosPregunta(puntosVivos); renderTiempo(DURACION);
      timer=setInterval(()=>{
        const trans=performance.now()-inicioPregunta; const rest=Math.max(0, DURACION-trans);
        puntosVivos=Math.max(0, MAX_PREGUNTA*(rest/DURACION));
        renderPuntosPregunta(puntosVivos); renderTiempo(rest);
        if(rest<=0){ detenerTemporizador(); procesarRespuesta(false,true); }
      },100);
    }
    function detenerTemporizador(){ if(timer){clearInterval(timer); timer=null;} }

    // selecci√≥n seg√∫n modo (Leitner/refuerzo)
    function pickSiguiente(){
      const now=Date.now();
      let candidates = pool.map((x,i)=>({i,item:x})).filter(o=>!usados.has(o.i));
      if(candidates.length===0){ usados.clear(); candidates = pool.map((x,i)=>({i,item:x})); }
      const modo = document.querySelector('input[name="modo"]:checked').value;

      if(modo==="leitner"){
        let due = candidates.filter(o => (LEITNER[o.item.id]?.due || 0) <= now);
        if(due.length===0){
          const nearest = candidates.sort((a,b)=>(LEITNER[a.item.id].due)-(LEITNER[b.item.id].due));
          due = nearest.slice(0, Math.min(8, nearest.length));
        }
        candidates = due;
      }
      if(chkRefuerzo.checked){
        candidates.sort((a,b)=>errorScore(b.item.id)-errorScore(a.item.id));
        const top = Math.max(1, Math.floor(candidates.length*0.3));
        candidates = candidates.slice(0, top);
      }
      return rand(candidates).i;
    }

    function siguiente(){
      if(preguntasContestadas>=LIMITE_PREGUNTAS){ mostrarResultados(); return; }

      bloqueado=false; $("#btnSiguiente").disabled=true;
      setFeedback(I18N[LANG].new_chance, "text-slate-600");
      $("#respuesta").value=""; $("#respuesta").disabled=false; $("#btnComprobar").disabled=false;

      if(pool.length===0) construirPool();
      const idx = pickSiguiente();
      usados.add(idx); actual = pool[idx]; actualizarProgreso();

      $("#categoria").textContent = actual.app;
      $("#categoria").className = "text-xs font-semibold rounded-full px-2 py-1 "+(actual.app==="macOS"?"bg-emerald-700":"bg-amber-600")+" text-white";
      $("#combo").innerHTML = renderCombo(actual.combo);
      $("#enunciado").textContent = I18N[LANG].ask_what_for;
      $("#lblCaja").textContent = LEITNER[actual.id]?.box ?? "‚Äì";
      $("#respuesta").focus();

      actualizarMarcador(); iniciarTemporizador();
    }

    /* =================== similitud (Levenshtein) =================== */
    function levenshtein(a,b){
      a=strip(a); b=strip(b);
      const m=a.length, n=b.length;
      if(m===0) return n; if(n===0) return m;
      const dp=new Array(n+1); for(let j=0;j<=n;j++) dp[j]=j;
      for(let i=1;i<=m;i++){
        let prev=dp[0], tmp; dp[0]=i;
        for(let j=1;j<=n;j++){
          tmp=dp[j];
          if(a[i-1]===b[j-1]) dp[j]=prev;
          else dp[j]=Math.min(prev+1, dp[j]+1, dp[j-1]+1);
          prev=tmp;
        }
      }
      return dp[n];
    }
    function similarity(a,b){
      const A=strip(a), B=strip(b);
      if(!A||!B) return 0;
      const dist=levenshtein(A,B); return 1 - (dist/Math.max(A.length,B.length));
    }
    function palabrasObjetivo(item){
      const base = [item.desc, ...(item.keywords||[])];
      const uniq=[]; for(const w of base){ const s=strip(w); if(s && !uniq.some(x=>similarity(x,s)>0.95)) uniq.push(s); }
      return uniq;
    }
    function coincide(res, item){
      const ans=strip(res); if(ans.length<2) return false;
      const TH = parseFloat(rngUmbral.value || "0.78");
      const targets = palabrasObjetivo(item);
      if(targets.some(k=>k===ans || k.includes(ans) || ans.includes(k))) return true;
      if(!chkSens.checked) return false;
      for(const k of targets){ if(similarity(ans,k) >= TH) return true; }
      return false;
    }

    /* =================== comprobar / feedback =================== */
    function procesarRespuesta(esCorrecto, porTiempo=false){
      if(bloqueado) return; bloqueado=true;
      detenerTemporizador(); $("#respuesta").disabled=true; $("#btnComprobar").disabled=true;

      let pts=0;
      if(esCorrecto){
        pts=Math.floor(puntosVivos); aciertos++; racha++; totalPuntos+=pts;
        setFeedback(I18N[LANG].correct(pts, actual.desc), "text-emerald-700");
      }else{
        racha=0; fallos++;
        setFeedback(porTiempo? I18N[LANG].wrong_time(actual.desc) : I18N[LANG].wrong_generic(actual.desc), "text-rose-700");
      }
      updateLeitner(actual.id, esCorrecto);
      $("#lblCaja").textContent = LEITNER[actual.id]?.box ?? "‚Äì";

      renderPuntosPregunta(0); preguntasContestadas++; actualizarMarcador();
      $("#btnSiguiente").disabled=false;

      setTimeout(()=>{ if(preguntasContestadas>=LIMITE_PREGUNTAS) mostrarResultados(); else siguiente(); }, 5000);
    }

    function comprobar(){
      if(bloqueado) return;
      const res=$("#respuesta").value;
      if(!res.trim()){
        setFeedback(LANG==="es"?"Escribe una pista breve y pulsa Comprobar. üí°":"Type a brief hint and press Check. üí°","text-blue-700"); return;
      }
      const ok = coincide(res, actual);
      procesarRespuesta(ok,false);
    }
    function pista(){
      const tip = (actual.keywords && actual.keywords.length) ? actual.keywords.slice(0,2).join(", ") : actual.desc.split(" ").slice(0,2).join(" ");
      setFeedback((LANG==="es"?"Pista: ":"Hint: ")+tip, "text-blue-700");
      $("#respuesta").focus();
    }
    function noSe(){ if(bloqueado) return; procesarRespuesta(false,false); }

    /* =================== modales: lista / dataset / analytics =================== */
    function construirTabla(){
      const cont=$("#tablaAtajos"); cont.innerHTML="";
      const grupos={"macOS": DATASET.filter(f=>f.app==="macOS"), "Excel (Mac)": DATASET.filter(f=>f.app==="Excel (Mac)")};
      for(const [titulo,arr] of Object.entries(grupos)){
        cont.insertAdjacentHTML("beforeend", `<h4 class="text-lg font-bold mt-4">${titulo}</h4>`);
        const grid=document.createElement("div"); grid.className="grid md:grid-cols-3 gap-2";
        arr.forEach(item=>{
          const card=document.createElement("div");
          card.className="border rounded-xl p-3 flex items-start gap-3 bg-white";
          const safeDesc=item.desc.replace(/</g,"&lt;");
          const safeCombo=item.combo.replace(/</g,"&lt;");
          const btnText = LANG==="es"?"Copiar":"Copy";
          card.innerHTML=`
            <div class="flex-1">
              <div class="font-semibold">${safeDesc}</div>
              <div class="mt-1 text-slate-600">${safeCombo}</div>
              <div class="mt-1 text-xs text-slate-500">${item.version} ¬∑ ${item.fuente||""}</div>
            </div>
            <button title="${btnText}"
              class="px-3 py-2 rounded-xl font-semibold shadow-sm border bg-white hover:bg-gray-50 text-sm"
              onclick="navigator.clipboard.writeText('${safeDesc.replace(/'/g,"\\'")}')">${btnText}</button>
          `;
          grid.appendChild(card);
        });
        cont.appendChild(grid);
      }
    }

    function construirAnalytics(){
      const cont=$("#tblAnalytics"); cont.innerHTML="";
      const rows = DATASET.map(it=>({it, r: LEITNER[it.id]||{ok:0,ko:0}}))
        .sort((a,b)=> (b.r.ko/Math.max(1,b.r.ok+b.r.ko)) - (a.r.ko/Math.max(1,a.r.ok+a.r.ko)));
      const header = document.createElement("div");
      header.className="grid grid-cols-[2fr_1fr_1fr_1fr] gap-2 font-semibold text-slate-600";
      header.innerHTML=`<div>${LANG==="es"?"Atajo":"Shortcut"}</div><div>${LANG==="es"?"Aciertos":"Hits"}</div><div>${LANG==="es"?"Fallos":"Misses"}</div><div>% KO</div>`;
      cont.appendChild(header);
      for(const {it,r} of rows){
        const pct = ((r.ko/Math.max(1,r.ok+r.ko))*100).toFixed(0);
        const row=document.createElement("div");
        row.className="grid grid-cols-[2fr_1fr_1fr_1fr] gap-2 border-b py-1";
        row.innerHTML=`<div class="truncate" title="${it.desc} - ${it.combo}">${it.desc} ¬∑ <span class="text-slate-500">${it.combo}</span></div>
                       <div>${r.ok||0}</div><div>${r.ko||0}</div><div>${pct}%</div>`;
        cont.appendChild(row);
      }
    }

    function mostrarResultados(){
      detenerTemporizador();
      $("#resAciertos").textContent=aciertos; $("#resFallos").textContent=fallos; $("#resPuntos").textContent=totalPuntos;
      dlgResultados.showModal();
    }
    function reiniciarTodo(){
      aciertos=0; fallos=0; racha=0; totalPuntos=0; preguntasContestadas=0;
      actualizarMarcador(); usados.clear(); actualizarProgreso(); siguiente();
    }

    // dataset editor
    function openDatasetEditor(){
      $("#txtDataset").value = localStorage.getItem(LS_DATASET) || $("#atajos-default").textContent.trim();
      dlgDataset.showModal();
    }
    $("#btnImport").addEventListener("click", async ()=>{
      const f=$("#fileImport").files?.[0]; if(!f) return alert(LANG==="es"?"Selecciona un archivo JSON.":"Select a JSON file.");
      const txt=await f.text(); $("#txtDataset").value=txt;
    });
    $("#btnExport").addEventListener("click", ()=>{
      const blob=new Blob([$("#txtDataset").value],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="atajos.json"; a.click();
      URL.revokeObjectURL(a.href);
    });
    $("#btnResetDataset").addEventListener("click", ()=>{
      $("#txtDataset").value = $("#atajos-default").textContent.trim();
    });
    $("#btnSaveDataset").addEventListener("click", ()=>{
      try{ JSON.parse($("#txtDataset").value); }catch(e){ alert((LANG==="es"?"JSON inv√°lido: ":"Invalid JSON: ")+e.message); return; }
      saveDatasetText($("#txtDataset").value);
      dlgDataset.close();
      alert(LANG==="es"?"Dataset actualizado.":"Dataset updated.");
    });

    /* =================== eventos UI =================== */
    $("#btnComprobar").addEventListener("click", comprobar);
    $("#respuesta").addEventListener("keydown", (e)=>{ if(e.key==="Enter") comprobar(); });
    $("#btnSiguiente").addEventListener("click", ()=>{ if(!bloqueado) noSe(); else siguiente(); });
    $("#btnPista").addEventListener("click", pista);
    $("#btnNoSe").addEventListener("click", noSe);
    $("#btnLista").addEventListener("click", ()=>{ construirTabla(); dlgLista.showModal(); });
    $("#btnReiniciar").addEventListener("click", ()=>{ reiniciarTodo(); setFeedback(LANG==="es"?"¬°Marcador a cero y energ√≠a al m√°ximo! üöÄ":"Score reset‚Äîlet‚Äôs go! üöÄ","text-slate-700"); });
    $("#btnVolverJugar").addEventListener("click", ()=>{ dlgResultados.close(); reiniciarTodo(); });
    $("#btnDataset").addEventListener("click", openDatasetEditor);
    $("#btnAnalytics").addEventListener("click", ()=>{ construirAnalytics(); dlgAnalytics.showModal(); });

    [chkMac, chkExcel, chkMezclar].forEach(el => el.addEventListener("change", ()=>{ construirPool(); siguiente(); }));

    rngUmbral.addEventListener("input", ()=>{ lblUmbral.textContent=parseFloat(rngUmbral.value).toFixed(2); });

    $("#selLang").addEventListener("change", ()=>{
      LANG=$("#selLang").value; localStorage.setItem(LS_SETTINGS, JSON.stringify({lang:LANG}));
      applyI18N(); construirTabla(); construirAnalytics();
    });

    /* =================== inicio =================== */
    (function init(){
      // idioma guardado
      try{ const s=JSON.parse(localStorage.getItem(LS_SETTINGS)||"{}"); if(s.lang) { LANG=s.lang; $("#selLang").value=LANG; } }catch{}
      applyI18N();

      loadDataset(); loadLeitner(); construirPool();
      actualizarMarcador(); siguiente();
      lblUmbral.textContent=parseFloat(rngUmbral.value).toFixed(2);
    })();
  </script>
</body>
</html>
